# -----------------------------------------------------------------------------
# Backend development image (hot-reload enabled)
# -----------------------------------------------------------------------------
FROM mirror.gcr.io/python:3.12.8-slim

ARG USER_NAME=knowledge-flow-user
ARG USER_ID=1000
ARG GROUP_ID=1000

# Install required system dependencies
RUN apt-get update && \
    apt-get install -y git curl && \
    rm -rf /var/lib/apt/lists/*

# Install uv globally
RUN curl -LsSf https://astral.sh/uv/install.sh | sh && \
    mv /root/.local/bin/uv /usr/local/bin/uv && \
    chmod +x /usr/local/bin/uv

# Setup user and permissions
RUN groupadd -g ${GROUP_ID} ${USER_NAME} && \
    useradd -u ${USER_ID} -g ${GROUP_ID} -m ${USER_NAME} && \
    mkdir -p /opt/python && \
    chown -R ${USER_ID}:${GROUP_ID} /opt/python

ENV UV_PROJECT_ENVIRONMENT=/opt/python/venv
ENV PATH="/opt/python/venv/bin:$PATH"
ENV OPENAI_API_KEY=<MUST_BE_DEFINED>

# Set working directory
WORKDIR /app

# Copy only dependency files first to leverage Docker layer caching
COPY pyproject.toml uv.lock* /app/

# Install dependencies with uv
RUN uv sync

# Copy the rest of the project files
COPY . /app

# Adjust ownership of copied files
RUN chown -R ${USER_ID}:${GROUP_ID} /app

# Switch to the created user
USER ${USER_NAME}

# Expose Fast API default port
EXPOSE 8111

# Run the application
ENV PYTHONPATH="/app"
ENTRYPOINT ["python", "knowledge_flow_app/main.py", "--server.reload", "--server.reloadDir=/app"]
